#!/bin/bash
# Script: trigger
# Description: This is the trigger engine. It crawls for IRC flags and triggers
#              the corresponding mods or scripts.
#
# - Manages the handling of $flag
# - Initiates corresponding modules if a command is triggered
# - Inititates the background scripts

# create source_nick, flag, channel and message segments
source_nick=$(echo $hostmask | cut -d "!" -f 1)
flag=$(echo $header | cut -d " " -f 2)
chan=$(echo $header | cut -d " " -f 3)
msg=${body}

case $flag in
	JOIN)
		#egrep "^($msg$|$msg $)" < var/channels &> /dev/null || echo $msg >> var/channels
		continue
		;;
	PART)
		# since part messages don't come with the colon, we have to trick around a bit
		msg=$(echo $line | cut -d ' ' -f3)
		egrep -v "^($msg$|$msg $)" < var/channels > var/channels.tmp && mv var/channels.tmp var/channels || echo "" > var/channels && rm var/channels.tmp
		continue
		;;
	INVITE)
		. mods/join $msg
		continue
		;;
	MODE)
		mode=$(echo $line | cut -d ' ' -f 4)
		mode_nick=$(echo $line | cut -d ' ' -f 5)
		. bin/message_triggers/mode
		;;
	KICK)
		# todo
		continue
		;;
	PRIVMSG)
		. bin/message_triggers/privmsg
		continue
		;;
esac
